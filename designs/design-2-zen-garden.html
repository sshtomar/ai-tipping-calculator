<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tippy â€” Zen Garden</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400;1,500&family=Outfit:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  /* ===== Reset & Base ===== */
  *, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --bg: #F7F3ED;
    --ink: #2C2C2C;
    --terracotta: #C4735B;
    --terracotta-hover: #b5664f;
    --sage: #7D9B76;
    --sage-dark: #6b8965;
    --warm-gray: #9E9689;
    --card: #FFFDF8;
    --sand: #F0EBE1;
    --divider: #DDD6CB;
    --font-serif: 'Cormorant Garamond', Georgia, serif;
    --font-sans: 'Outfit', -apple-system, sans-serif;
  }

  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  body {
    font-family: var(--font-sans);
    font-weight: 400;
    color: var(--ink);
    background-color: var(--bg);
    min-height: 100vh;
    min-height: 100dvh;
    display: flex;
    justify-content: center;
    /* Paper texture via CSS */
    background-image:
      url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  }

  /* ===== App Shell ===== */
  .app {
    width: 100%;
    max-width: 430px;
    min-height: 100vh;
    min-height: 100dvh;
    position: relative;
    overflow: hidden;
  }

  /* ===== Screens ===== */
  .screen {
    display: none;
    flex-direction: column;
    padding: 48px 28px 40px;
    min-height: 100vh;
    min-height: 100dvh;
    opacity: 0;
  }

  .screen.active {
    display: flex;
    animation: screenFadeIn 500ms ease-out forwards;
  }

  @keyframes screenFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* ===== Staggered Fade-Up ===== */
  .fade-up {
    opacity: 0;
    transform: translateY(18px);
    transition: opacity 400ms ease-out, transform 400ms ease-out;
  }

  .fade-up.visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* ===== Enso Logo ===== */
  .enso-container {
    display: flex;
    justify-content: center;
    margin-bottom: 8px;
  }

  .enso-logo {
    width: 48px;
    height: 48px;
  }

  .enso-logo circle {
    fill: none;
    stroke: var(--ink);
    stroke-width: 2.5;
    stroke-linecap: round;
  }

  .brand-name {
    text-align: center;
    font-family: var(--font-serif);
    font-size: 1.125rem;
    font-weight: 400;
    letter-spacing: 0.18em;
    color: var(--warm-gray);
    margin-bottom: 40px;
    text-transform: lowercase;
  }

  /* ===== Divider ===== */
  .divider {
    width: 100%;
    height: 1px;
    background: var(--divider);
    margin: 28px 0;
  }

  .divider.thin {
    width: 64px;
    margin: 20px auto;
  }

  /* ===== Section Headings ===== */
  .section-heading {
    font-family: var(--font-serif);
    font-size: 1.35rem;
    font-weight: 400;
    color: var(--ink);
    letter-spacing: 0.01em;
    line-height: 1.4;
  }

  .section-subheading {
    font-family: var(--font-sans);
    font-size: 0.8rem;
    font-weight: 300;
    color: var(--warm-gray);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  /* ===== Entry Screen ===== */
  .amount-input-wrapper {
    margin: 8px 0 36px;
    text-align: center;
  }

  .amount-display {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 4px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--ink);
    max-width: 240px;
    margin: 0 auto;
    cursor: text;
    transition: border-color 300ms ease;
  }

  .amount-display:focus-within,
  .amount-display.focused {
    border-color: var(--terracotta);
  }

  .dollar-sign {
    font-family: var(--font-serif);
    font-size: 2rem;
    font-weight: 300;
    color: var(--warm-gray);
    line-height: 1;
  }

  .amount-value {
    font-family: var(--font-serif);
    font-size: 3.2rem;
    font-weight: 300;
    letter-spacing: -0.02em;
    line-height: 1;
    color: var(--ink);
    min-width: 40px;
  }

  .amount-input-hidden {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .amount-cursor {
    display: inline-block;
    width: 2px;
    height: 2.8rem;
    background: var(--terracotta);
    margin-left: 2px;
    animation: cursorBlink 1.1s step-end infinite;
    vertical-align: baseline;
    opacity: 0;
    transition: opacity 200ms;
  }

  .amount-display.focused .amount-cursor {
    opacity: 1;
  }

  @keyframes cursorBlink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  .amount-display.focused .amount-cursor {
    animation: cursorBlink 1.1s step-end infinite;
  }

  .service-question {
    font-family: var(--font-serif);
    font-size: 1.2rem;
    font-weight: 400;
    color: var(--warm-gray);
    margin-bottom: 20px;
    font-style: italic;
  }

  /* ===== Service Grid ===== */
  .service-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 32px;
  }

  .service-card {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 16px;
    background: var(--card);
    border: 1px solid var(--divider);
    border-radius: 14px;
    cursor: pointer;
    transition: all 250ms ease;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  .service-card:hover {
    border-color: var(--warm-gray);
  }

  .service-card:active {
    transform: scale(0.97);
  }

  .service-card.selected {
    border-color: var(--terracotta);
    background: #FFF9F5;
    box-shadow: 0 0 0 1px var(--terracotta);
  }

  .service-card .emoji {
    font-size: 1.3rem;
    line-height: 1;
    flex-shrink: 0;
  }

  .service-card .label {
    font-family: var(--font-sans);
    font-size: 0.82rem;
    font-weight: 400;
    letter-spacing: 0.02em;
    color: var(--ink);
  }

  /* ===== Primary Button ===== */
  .btn-primary {
    width: 100%;
    padding: 16px 32px;
    background: var(--terracotta);
    color: #fff;
    border: none;
    border-radius: 50px;
    font-family: var(--font-sans);
    font-size: 0.9rem;
    font-weight: 400;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 200ms ease;
    -webkit-tap-highlight-color: transparent;
    margin-top: auto;
  }

  .btn-primary:hover {
    background: var(--terracotta-hover);
  }

  .btn-primary:active {
    transform: scale(0.97);
  }

  .btn-primary:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  /* ===== Context Screen ===== */
  .context-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 28px;
  }

  .pill {
    padding: 10px 18px;
    border: 1px solid var(--divider);
    border-radius: 50px;
    font-family: var(--font-sans);
    font-size: 0.82rem;
    font-weight: 400;
    color: var(--ink);
    background: var(--card);
    cursor: pointer;
    transition: all 250ms ease;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    letter-spacing: 0.02em;
  }

  .pill:hover {
    border-color: var(--sage);
  }

  .pill:active {
    transform: scale(0.97);
  }

  .pill.selected {
    background: var(--sage);
    border-color: var(--sage);
    color: #fff;
  }

  .context-textarea {
    width: 100%;
    min-height: 100px;
    padding: 16px 18px;
    border: 1px solid var(--divider);
    border-radius: 16px;
    background: var(--card);
    font-family: var(--font-sans);
    font-size: 0.88rem;
    font-weight: 300;
    color: var(--ink);
    resize: vertical;
    outline: none;
    transition: border-color 300ms ease;
    letter-spacing: 0.01em;
    line-height: 1.6;
  }

  .context-textarea::placeholder {
    color: var(--warm-gray);
    font-style: italic;
  }

  .context-textarea:focus {
    border-color: var(--sage);
  }

  .skip-link {
    display: block;
    text-align: center;
    margin-top: 16px;
    font-family: var(--font-sans);
    font-size: 0.8rem;
    color: var(--warm-gray);
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: color 200ms;
    -webkit-tap-highlight-color: transparent;
    background: none;
    border: none;
    padding: 8px;
  }

  .skip-link:hover {
    color: var(--ink);
  }

  /* ===== Loading Screen ===== */
  .loading-screen {
    justify-content: center;
    align-items: center;
  }

  .enso-drawing {
    width: 120px;
    height: 120px;
    margin-bottom: 36px;
  }

  .enso-drawing .enso-path {
    fill: none;
    stroke: var(--ink);
    stroke-width: 2.5;
    stroke-linecap: round;
    stroke-dasharray: 290;
    stroke-dashoffset: 290;
  }

  .enso-drawing.animate .enso-path {
    animation: drawEnso 2.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  @keyframes drawEnso {
    0% {
      stroke-dashoffset: 290;
      opacity: 0.3;
    }
    10% {
      opacity: 1;
    }
    70% {
      stroke-dashoffset: 20;
    }
    100% {
      stroke-dashoffset: 18;
      opacity: 1;
    }
  }

  .loading-text {
    font-family: var(--font-serif);
    font-size: 1.2rem;
    font-weight: 400;
    font-style: italic;
    color: var(--warm-gray);
    letter-spacing: 0.02em;
    text-align: center;
  }

  .loading-dots::after {
    content: '';
    animation: dots 1.5s steps(4, end) infinite;
  }

  @keyframes dots {
    0%   { content: ''; }
    25%  { content: '.'; }
    50%  { content: '..'; }
    75%  { content: '...'; }
    100% { content: ''; }
  }

  /* Breathing glow behind enso */
  .enso-glow {
    position: absolute;
    width: 160px;
    height: 160px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(196,115,91,0.08) 0%, transparent 70%);
    animation: breathe 3s ease-in-out infinite;
  }

  @keyframes breathe {
    0%, 100% { transform: scale(0.9); opacity: 0.4; }
    50% { transform: scale(1.15); opacity: 1; }
  }

  .loading-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  /* ===== Result Screen ===== */
  .result-header {
    text-align: center;
    margin-bottom: 28px;
  }

  .result-label {
    font-family: var(--font-sans);
    font-size: 0.72rem;
    font-weight: 400;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--warm-gray);
    margin-bottom: 4px;
  }

  .tip-cards {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 28px;
  }

  .tip-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 20px;
    background: var(--card);
    border: 1px solid var(--divider);
    border-radius: 16px;
    cursor: pointer;
    transition: all 250ms ease;
    -webkit-tap-highlight-color: transparent;
    position: relative;
  }

  .tip-card:active {
    transform: scale(0.98);
  }

  .tip-card.selected {
    border-color: var(--terracotta);
    box-shadow: 0 2px 16px rgba(196,115,91,0.1);
  }

  .tip-card.recommended {
    border-left: 3px solid var(--terracotta);
    padding-left: 17px;
  }

  .tip-card .tip-left {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .tip-card .tip-label {
    font-family: var(--font-sans);
    font-size: 0.82rem;
    font-weight: 400;
    color: var(--warm-gray);
    letter-spacing: 0.04em;
  }

  .tip-card .tip-label-rec {
    font-family: var(--font-sans);
    font-size: 0.68rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--terracotta);
  }

  .tip-card .tip-right {
    display: flex;
    align-items: baseline;
    gap: 10px;
  }

  .tip-card .tip-amount {
    font-family: var(--font-serif);
    font-size: 1.65rem;
    font-weight: 400;
    color: var(--ink);
    letter-spacing: -0.02em;
  }

  .tip-card .tip-pct {
    font-family: var(--font-sans);
    font-size: 0.7rem;
    font-weight: 400;
    letter-spacing: 0.04em;
    color: #fff;
    background: var(--warm-gray);
    padding: 3px 8px;
    border-radius: 20px;
  }

  .tip-card.recommended .tip-pct {
    background: var(--terracotta);
  }

  .tip-card .tip-total {
    font-family: var(--font-sans);
    font-size: 0.75rem;
    font-weight: 300;
    color: var(--warm-gray);
  }

  /* ===== Explanation Card ===== */
  .explanation-card {
    background: var(--sand);
    border-radius: 16px;
    padding: 20px 22px;
    margin-bottom: 28px;
  }

  .explanation-text {
    font-family: var(--font-serif);
    font-size: 1rem;
    font-weight: 400;
    font-style: italic;
    color: var(--ink);
    line-height: 1.65;
    letter-spacing: 0.01em;
    opacity: 0.85;
  }

  /* ===== Split Section ===== */
  .split-section {
    margin-bottom: 32px;
  }

  .split-heading {
    font-family: var(--font-serif);
    font-size: 1.1rem;
    font-weight: 400;
    color: var(--ink);
    margin-bottom: 16px;
    font-style: italic;
  }

  .split-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 28px;
  }

  .split-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 1px solid var(--divider);
    background: var(--card);
    font-family: var(--font-sans);
    font-size: 1.2rem;
    color: var(--ink);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 200ms ease;
    -webkit-tap-highlight-color: transparent;
  }

  .split-btn:hover {
    border-color: var(--warm-gray);
  }

  .split-btn:active {
    transform: scale(0.93);
  }

  .split-count {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 80px;
  }

  .split-number {
    font-family: var(--font-serif);
    font-size: 2rem;
    font-weight: 400;
    color: var(--ink);
    line-height: 1;
  }

  .split-label {
    font-family: var(--font-sans);
    font-size: 0.72rem;
    color: var(--warm-gray);
    letter-spacing: 0.06em;
    margin-top: 4px;
  }

  .split-result {
    text-align: center;
    margin-top: 16px;
    padding: 14px;
    background: var(--card);
    border-radius: 12px;
    border: 1px solid var(--divider);
  }

  .split-per-person {
    font-family: var(--font-serif);
    font-size: 1.3rem;
    font-weight: 400;
    color: var(--ink);
  }

  .split-per-label {
    font-family: var(--font-sans);
    font-size: 0.72rem;
    color: var(--warm-gray);
    letter-spacing: 0.04em;
    margin-top: 2px;
  }

  /* ===== Begin Again ===== */
  .begin-again {
    display: block;
    width: fit-content;
    margin: 8px auto 0;
    padding: 12px 20px;
    background: none;
    border: none;
    font-family: var(--font-sans);
    font-size: 0.82rem;
    font-weight: 400;
    color: var(--warm-gray);
    letter-spacing: 0.06em;
    cursor: pointer;
    transition: color 200ms;
    -webkit-tap-highlight-color: transparent;
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-color: var(--divider);
  }

  .begin-again:hover {
    color: var(--ink);
    text-decoration-color: var(--ink);
  }

  /* ===== Scrollbar ===== */
  .screen::-webkit-scrollbar { width: 0; }
  .screen { scrollbar-width: none; overflow-y: auto; }

  /* ===== Desktop refinement ===== */
  @media (min-width: 500px) {
    body {
      align-items: center;
      padding: 20px 0;
    }
    .app {
      min-height: auto;
      border-radius: 32px;
      box-shadow: 0 8px 60px rgba(44,44,44,0.06), 0 1px 3px rgba(44,44,44,0.04);
      overflow: hidden;
      background: var(--bg);
      background-image:
        url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    }
    .screen {
      min-height: 720px;
    }
  }
</style>
</head>
<body>

<div class="app" id="app">

  <!-- ==================== SCREEN 1: ENTRY ==================== -->
  <div class="screen active" id="screen-entry">
    <div class="enso-container fade-up">
      <svg class="enso-logo" viewBox="0 0 48 48">
        <circle cx="24" cy="24" r="18" stroke-dasharray="105 8" stroke-dashoffset="12" />
      </svg>
    </div>
    <div class="brand-name fade-up">tippy</div>

    <div class="amount-input-wrapper fade-up">
      <div class="amount-display" id="amountDisplay" tabindex="0">
        <span class="dollar-sign">$</span>
        <span class="amount-value" id="amountValue">0</span>
        <span class="amount-cursor"></span>
      </div>
      <input type="text" inputmode="decimal" class="amount-input-hidden" id="amountInput" autocomplete="off" />
    </div>

    <div class="service-question fade-up">What kind of service?</div>

    <div class="service-grid fade-up" id="serviceGrid">
      <div class="service-card" data-service="restaurant">
        <span class="emoji">&#127869;</span>
        <span class="label">Restaurant</span>
      </div>
      <div class="service-card" data-service="bar">
        <span class="emoji">&#127864;</span>
        <span class="label">Bar</span>
      </div>
      <div class="service-card" data-service="cafe">
        <span class="emoji">&#9749;</span>
        <span class="label">Cafe</span>
      </div>
      <div class="service-card" data-service="delivery">
        <span class="emoji">&#128663;</span>
        <span class="label">Delivery</span>
      </div>
      <div class="service-card" data-service="rideshare">
        <span class="emoji">&#128661;</span>
        <span class="label">Rideshare</span>
      </div>
      <div class="service-card" data-service="salon">
        <span class="emoji">&#128135;</span>
        <span class="label">Salon</span>
      </div>
      <div class="service-card" data-service="spa">
        <span class="emoji">&#128134;</span>
        <span class="label">Spa</span>
      </div>
      <div class="service-card" data-service="tattoo">
        <span class="emoji">&#127912;</span>
        <span class="label">Tattoo</span>
      </div>
      <div class="service-card" data-service="valet">
        <span class="emoji">&#127359;&#65039;</span>
        <span class="label">Valet</span>
      </div>
      <div class="service-card" data-service="hotel">
        <span class="emoji">&#127976;</span>
        <span class="label">Hotel</span>
      </div>
      <div class="service-card" data-service="movers">
        <span class="emoji">&#128230;</span>
        <span class="label">Movers</span>
      </div>
    </div>

    <button class="btn-primary" id="btnEntry" disabled>Continue</button>
  </div>

  <!-- ==================== SCREEN 2: CONTEXT ==================== -->
  <div class="screen" id="screen-context">
    <div class="enso-container fade-up">
      <svg class="enso-logo" viewBox="0 0 48 48">
        <circle cx="24" cy="24" r="18" stroke-dasharray="105 8" stroke-dashoffset="12" />
      </svg>
    </div>
    <div class="brand-name fade-up">tippy</div>

    <div class="section-heading fade-up" style="margin-bottom: 24px; font-style: italic;">Any context to share?</div>

    <div class="context-pills fade-up" id="contextPills">
      <div class="pill" data-tag="business">Business dinner</div>
      <div class="pill" data-tag="date">Date night</div>
      <div class="pill" data-tag="holiday">Holiday season</div>
      <div class="pill" data-tag="group">Large group</div>
      <div class="pill" data-tag="outstanding">Outstanding service</div>
      <div class="pill" data-tag="poor">Poor service</div>
      <div class="pill" data-tag="takeout">Takeout</div>
      <div class="pill" data-tag="buffet">Buffet</div>
    </div>

    <textarea class="context-textarea fade-up" id="contextNote" placeholder="Tell us more..."></textarea>

    <div style="margin-top: auto; padding-top: 24px;">
      <button class="btn-primary fade-up" id="btnContext">Continue</button>
      <button class="skip-link fade-up" id="btnSkipContext">Skip this step</button>
    </div>
  </div>

  <!-- ==================== SCREEN 3: LOADING ==================== -->
  <div class="screen loading-screen" id="screen-loading">
    <div class="loading-center">
      <div class="enso-glow"></div>
      <svg class="enso-drawing" id="ensoDrawing" viewBox="0 0 120 120">
        <path class="enso-path"
          d="M 60 15
             C 85 15, 107 35, 107 60
             C 107 85, 85 107, 60 107
             C 35 107, 13 85, 13 60
             C 13 35, 35 15, 58 15"
        />
      </svg>
      <div class="loading-text">Finding your balance<span class="loading-dots"></span></div>
    </div>
  </div>

  <!-- ==================== SCREEN 4: RESULT ==================== -->
  <div class="screen" id="screen-result">
    <div class="enso-container fade-up">
      <svg class="enso-logo" viewBox="0 0 48 48">
        <circle cx="24" cy="24" r="18" stroke-dasharray="105 8" stroke-dashoffset="12" />
      </svg>
    </div>
    <div class="brand-name fade-up">tippy</div>

    <div class="result-header fade-up">
      <div class="result-label">Your recommendation</div>
    </div>

    <div class="tip-cards" id="tipCards">
      <!-- Filled by JS -->
    </div>

    <div class="explanation-card fade-up" id="explanationCard">
      <p class="explanation-text" id="explanationText"></p>
    </div>

    <div class="divider fade-up"></div>

    <div class="split-section fade-up">
      <div class="split-heading">Splitting the bill?</div>
      <div class="split-controls">
        <button class="split-btn" id="splitMinus" aria-label="Decrease split">&minus;</button>
        <div class="split-count">
          <span class="split-number" id="splitNumber">1</span>
          <span class="split-label" id="splitLabel">person</span>
        </div>
        <button class="split-btn" id="splitPlus" aria-label="Increase split">+</button>
      </div>
      <div class="split-result" id="splitResult" style="display: none;">
        <div class="split-per-person" id="splitAmount"></div>
        <div class="split-per-label">per person (bill + tip)</div>
      </div>
    </div>

    <button class="begin-again fade-up" id="btnReset">Begin again</button>
  </div>

</div>

<script>
(function() {
  'use strict';

  // ===== State =====
  const state = {
    amount: '',
    service: null,
    tags: new Set(),
    note: '',
    selectedTip: 1, // index of selected tip (0,1,2)
    splitCount: 1,
    tips: []
  };

  // ===== DOM =====
  const $ = id => document.getElementById(id);
  const screens = {
    entry: $('screen-entry'),
    context: $('screen-context'),
    loading: $('screen-loading'),
    result: $('screen-result')
  };

  // ===== Fade-up observer =====
  function animateFadeUps(screen) {
    const els = screen.querySelectorAll('.fade-up');
    els.forEach((el, i) => {
      el.classList.remove('visible');
      setTimeout(() => el.classList.add('visible'), 80 + i * 100);
    });
  }

  // ===== Screen Navigation =====
  function goTo(name) {
    Object.values(screens).forEach(s => s.classList.remove('active'));
    const target = screens[name];
    target.classList.add('active');
    target.scrollTop = 0;
    animateFadeUps(target);

    if (name === 'loading') {
      startLoading();
    }
  }

  // Init first screen
  setTimeout(() => animateFadeUps(screens.entry), 60);

  // ===== Amount Input =====
  const amountDisplay = $('amountDisplay');
  const amountValue = $('amountValue');
  const amountInput = $('amountInput');

  amountDisplay.addEventListener('click', () => {
    amountInput.focus();
  });

  amountDisplay.addEventListener('focus', () => {
    amountInput.focus();
  });

  amountInput.addEventListener('focus', () => {
    amountDisplay.classList.add('focused');
  });

  amountInput.addEventListener('blur', () => {
    amountDisplay.classList.remove('focused');
  });

  amountInput.addEventListener('input', (e) => {
    let val = e.target.value.replace(/[^0-9.]/g, '');
    // Allow only one decimal point
    const parts = val.split('.');
    if (parts.length > 2) val = parts[0] + '.' + parts.slice(1).join('');
    // Limit decimal places to 2
    if (parts.length === 2 && parts[1].length > 2) {
      val = parts[0] + '.' + parts[1].slice(0, 2);
    }
    state.amount = val;
    e.target.value = val;
    amountValue.textContent = val || '0';
    updateEntryButton();
  });

  // Also handle keyboard on the display for accessibility
  amountDisplay.addEventListener('keydown', (e) => {
    if (e.key.length === 1 || e.key === 'Backspace') {
      amountInput.focus();
    }
  });

  // ===== Service Selection =====
  const serviceGrid = $('serviceGrid');
  serviceGrid.addEventListener('click', (e) => {
    const card = e.target.closest('.service-card');
    if (!card) return;
    serviceGrid.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    state.service = card.dataset.service;
    updateEntryButton();
  });

  function updateEntryButton() {
    const btn = $('btnEntry');
    const amt = parseFloat(state.amount);
    btn.disabled = !(amt > 0 && state.service);
  }

  $('btnEntry').addEventListener('click', () => {
    if ($('btnEntry').disabled) return;
    goTo('context');
  });

  // ===== Context Pills =====
  const contextPills = $('contextPills');
  contextPills.addEventListener('click', (e) => {
    const pill = e.target.closest('.pill');
    if (!pill) return;
    const tag = pill.dataset.tag;
    if (state.tags.has(tag)) {
      state.tags.delete(tag);
      pill.classList.remove('selected');
    } else {
      state.tags.add(tag);
      pill.classList.add('selected');
    }
  });

  $('btnContext').addEventListener('click', () => {
    state.note = $('contextNote').value;
    goTo('loading');
  });

  $('btnSkipContext').addEventListener('click', () => {
    goTo('loading');
  });

  // ===== Loading =====
  function startLoading() {
    const enso = $('ensoDrawing');
    enso.classList.remove('animate');
    // Force reflow
    void enso.offsetWidth;
    enso.classList.add('animate');
    setTimeout(() => {
      computeTips();
      goTo('result');
    }, 2500);
  }

  // ===== Tip Calculation =====
  const serviceData = {
    restaurant: { low: 18, mid: 20, high: 25, explanation: "A {pct}% tip honors good restaurant service \u2014 enough to be remembered kindly." },
    bar:        { low: 18, mid: 20, high: 25, explanation: "Bartenders craft your experience. {pct}% reflects appreciation for their attention." },
    cafe:       { low: 15, mid: 18, high: 20, explanation: "A thoughtful {pct}% acknowledges the care in your morning ritual." },
    delivery:   { low: 15, mid: 18, high: 22, explanation: "Your meal traveled to you. {pct}% thanks the person who carried it." },
    rideshare:  { low: 15, mid: 18, high: 22, explanation: "A {pct}% tip respects the journey and the one who navigated it for you." },
    salon:      { low: 18, mid: 20, high: 25, explanation: "Your stylist invests skill and care. {pct}% honors that craft." },
    spa:        { low: 18, mid: 20, high: 25, explanation: "Wellness is personal. {pct}% acknowledges the healing hands that served you." },
    tattoo:     { low: 20, mid: 25, high: 30, explanation: "Art on skin is deeply personal. {pct}% respects the artistry and permanence." },
    valet:      { low: 15, mid: 18, high: 20, explanation: "A {pct}% gesture of thanks for the care taken with your vehicle." },
    hotel:      { low: 15, mid: 18, high: 22, explanation: "Hospitality is an art. {pct}% acknowledges those who make you feel at home." },
    movers:     { low: 15, mid: 20, high: 25, explanation: "Moving is hard labor. {pct}% recognizes the physical effort and care with your belongings." }
  };

  const tipLabels = ['Modest', 'Recommended', 'Generous'];

  function computeTips() {
    const amount = parseFloat(state.amount);
    const data = serviceData[state.service] || serviceData.restaurant;

    // Adjust based on context
    let lowPct = data.low;
    let midPct = data.mid;
    let highPct = data.high;

    if (state.tags.has('outstanding')) { lowPct += 2; midPct += 3; highPct += 3; }
    if (state.tags.has('poor')) { lowPct -= 3; midPct -= 3; highPct -= 2; }
    if (state.tags.has('holiday')) { lowPct += 1; midPct += 2; highPct += 2; }
    if (state.tags.has('group')) { midPct += 1; highPct += 1; }

    lowPct = Math.max(lowPct, 5);

    state.tips = [
      { label: tipLabels[0], pct: lowPct, amount: Math.round(amount * lowPct) / 100 },
      { label: tipLabels[1], pct: midPct, amount: Math.round(amount * midPct) / 100 },
      { label: tipLabels[2], pct: highPct, amount: Math.round(amount * highPct) / 100 }
    ];

    state.selectedTip = 1;
    state.splitCount = 1;

    renderResult(amount, data);
  }

  function renderResult(amount, data) {
    const tipCards = $('tipCards');
    tipCards.innerHTML = '';

    state.tips.forEach((tip, i) => {
      const card = document.createElement('div');
      card.className = 'tip-card fade-up' + (i === 1 ? ' recommended' : '') + (i === state.selectedTip ? ' selected' : '');
      card.dataset.index = i;

      const total = amount + tip.amount;
      card.innerHTML = `
        <div class="tip-left">
          <div class="tip-label">${tip.label}</div>
          ${i === 1 ? '<div class="tip-label-rec">Recommended</div>' : ''}
          <div class="tip-total">Total: $${total.toFixed(2)}</div>
        </div>
        <div class="tip-right">
          <span class="tip-amount">$${tip.amount.toFixed(2)}</span>
          <span class="tip-pct">${tip.pct}%</span>
        </div>
      `;
      tipCards.appendChild(card);
    });

    // Explanation
    const explanation = data.explanation.replace('{pct}', state.tips[state.selectedTip].pct);
    $('explanationText').textContent = explanation;

    // Animate
    setTimeout(() => {
      tipCards.querySelectorAll('.fade-up').forEach((el, i) => {
        setTimeout(() => el.classList.add('visible'), 80 + i * 100);
      });
    }, 60);

    // Tip card click
    tipCards.addEventListener('click', (e) => {
      const card = e.target.closest('.tip-card');
      if (!card) return;
      tipCards.querySelectorAll('.tip-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      state.selectedTip = parseInt(card.dataset.index);
      const newExplanation = data.explanation.replace('{pct}', state.tips[state.selectedTip].pct);
      $('explanationText').textContent = newExplanation;
      updateSplit();
    });

    updateSplit();
  }

  // ===== Split =====
  $('splitMinus').addEventListener('click', () => {
    if (state.splitCount > 1) {
      state.splitCount--;
      updateSplit();
    }
  });

  $('splitPlus').addEventListener('click', () => {
    if (state.splitCount < 20) {
      state.splitCount++;
      updateSplit();
    }
  });

  function updateSplit() {
    $('splitNumber').textContent = state.splitCount;
    $('splitLabel').textContent = state.splitCount === 1 ? 'person' : 'people';
    const splitResult = $('splitResult');

    if (state.splitCount > 1) {
      const amount = parseFloat(state.amount);
      const tip = state.tips[state.selectedTip].amount;
      const total = amount + tip;
      const perPerson = total / state.splitCount;
      $('splitAmount').textContent = '$' + perPerson.toFixed(2);
      splitResult.style.display = 'block';
    } else {
      splitResult.style.display = 'none';
    }
  }

  // ===== Reset =====
  $('btnReset').addEventListener('click', () => {
    state.amount = '';
    state.service = null;
    state.tags.clear();
    state.note = '';
    state.selectedTip = 1;
    state.splitCount = 1;

    amountInput.value = '';
    amountValue.textContent = '0';
    serviceGrid.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
    contextPills.querySelectorAll('.pill').forEach(p => p.classList.remove('selected'));
    $('contextNote').value = '';
    updateEntryButton();
    goTo('entry');
  });

})();
</script>

</body>
</html>
